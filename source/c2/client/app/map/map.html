<style>
  .info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
  }
  .info h4 {
    margin: 0 0 5px;
    color: #777;
  }
  .legend {
    line-height: 18px;
    color: #555;
  }
  .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }
</style>

<div ng-include="'components/navbar/navbar.html'"></div>
<div class="container-fluid">
    <div class="row main-row">
        <!-- MAP VIEWER -->
        <div id="map" class="col-sm-10 map-col">
        </div>

        <!-- CRITERIA FILTERS -->
        <div class="col-sm-2 selector-col">
            <div ng-include="'components/criteria-picker/criteria-picker.html'"></div>
        </div>

    </div>
</div>
<script>
  // Initialize some variables...
  var map;
  var states;
  var pane;
  var identifiedFeature;
  // Functions for interacting with the map
  function zoomToFeature(e) {
    console.log('map.html: ok');
    map.fitBounds(e.target.getBounds());
  }

  // For assigning colors based on crop harvest
  // Generated by colorbrewer2.org
  function getColor(d) {
    return d > 250000  ? '#004529' :
           d > 100000  ? '#006837' :
           d > 50000   ? '#238443' :
           d > 25000   ? '#41AB5D' :
           d > 10000   ? '#78C679' :
           d > 5000    ? '#ADDD8E' :
           d > 1000    ? '#D9F0A3' :
           d > 100     ? '#F7FCB9' :
                         '#FFFFE5';
  }
  function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
  }

  function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
  }
	
  function getStateColor(d, max) {	
    var c = Math.floor(255 - (d / max * 255));
    c = Math.min(c,255);
    c = Math.max(c,0);
		
    if(isNaN(c)) return rgbToHex(255,255,255);		
      return rgbToHex(255,c,c);
  }

  function style(stateValue, max) {
    return {
      fillColor: getColor(stateValue), //getStateColor(stateValue, max),
      weight: 2,
      opacity: 1,
      color: '#000000',
      dashArray: '4',
      fillOpacity: 0.5
    };
  }

  // Workaround...
  var setint = setInterval(function() {
    if(typeof require != undefined) {
      clearInterval(setint);
      // Initialize the map
      map = L.map('map').setView([37.78, -92.85], 4); // All of US
      //map.on('click', onMapClick);

      L.esri.basemapLayer('Gray').addTo(map);
      //states = L.esri.featureLayer('http://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0', {
      //states = L.esri.dynamicMapLayer('http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer', {
      states = L.esri.dynamicMapLayer('http://sampleserver5.arcgisonline.com/arcgis/rest/services/USA/MapServer', {
          layers: [2],
          opacity: 0.5,
          useCors: false
      }).addTo(map);

      // Auto-zoom on load
      /*L.esri.Geocoding.geocode().text('Virginia').run(function (error, response) {
          map.fitBounds(response.results[0].bounds);
      });*/

      // Include handy Geosearch control
      var searchControl = new L.esri.Geocoding.Controls.Geosearch().addTo(map);
      var results = new L.LayerGroup().addTo(map);
      searchControl.on('results', function(data){
        results.clearLayers();
        for (var i = data.results.length - 1; i >= 0; i--) {
          results.addLayer(L.marker(data.results[i].latlng));
        }
      });

      // Pane for showing relevant data
      var info = L.control({position: 'topright'});
      info.onAdd = function (map) {
        pane = L.DomUtil.create('div', 'info'); // create a div with a class "info"
        pane.innerHTML += 'No State Selected'; // Initial text
        return pane;
      };
      info.addTo(map);

      // Include static Legend
      var legend = L.control({position: 'bottomright'});
      legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 100, 1000, 5000, 10000, 25000, 50000, 100000, 250000],
            labels = [];

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
          div.innerHTML +=
              '<i style="background:' + getColor(grades[i] + 1, 0) + '"></i> ' +
              grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
        }  
        return div;
      };
      legend.addTo(map);
      
      console.log('map.html: Successfully loaded map!');    
    }
  }, 500);
</script>

<div ng-include="'components/footer/footer.html'"></div>

