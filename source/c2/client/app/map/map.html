<style>
  #selectedFeatures {
    position: absolute;
    top: 100px;
    right: 280px;
    z-index: 10;
    background: white;
    padding: 1em;
  }
</style>

<div ng-include="'components/navbar/navbar.html'"></div>
<div class="container-fluid">
    <div class="row main-row">
        <!-- MAP VIEWER -->
        <div id="map" class="col-sm-10 map-col">
        </div>
        <div id="selectedFeatures" class="leaflet-bar">No Features Selected</div>

        <!-- CRITERIA FILTERS -->
        <div class="col-sm-2 selector-col">
            <div ng-include="'components/criteria-picker/criteria-picker.html'"></div>
        </div>

    </div>
</div>
<script>
  // Needed for waiting for libs to load
  function sleep(milliseconds) {
    var start = new Date().getTime();
    for (var i = 0; i < 1e7; i++) {
      if ((new Date().getTime() - start) > milliseconds){
        break;
      }
    }
  }

  /*function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
  }
  function onEachFeature(feature, layer) {
    layer.on({
      click: zoomToFeature
    });
  }*/

  var identifiedFeature;
  var pane;
  var states;
  var map;

  // Workaround...
  var setint = setInterval(function() {

    if(typeof require != undefined && typeof L.esri != undefined)
    {
      clearInterval(setint);

      map = L.map('map').setView([37.78, -92.85], 4); // All of US
      L.esri.basemapLayer('Streets').addTo(map);
      console.log('Successfully loaded map!');
      /*states = L.esri.featureLayer('http://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0', {
        opacity: 0.5,
        useCors: false
      }).addTo(map);*/
   
      // Auto-zoom on load
      /*L.esri.Geocoding.geocode().text('Virginia').run(function (error, response) {
          map.fitBounds(response.results[0].bounds);
      });*/
      
      var searchControl = new L.esri.Geocoding.Controls.Geosearch().addTo(map);
      var results = new L.LayerGroup().addTo(map);
      searchControl.on('results', function(data){
        results.clearLayers();
        for (var i = data.results.length - 1; i >= 0; i--) {
          results.addLayer(L.marker(data.results[i].latlng));
        }
      });

      pane = document.getElementById('selectedFeatures');
      /*L.geoJson(states, {
        onEachFeature: onEachFeature
      }).addTo(map);*/
      /*map.on('click', function (e) {
        if(identifiedFeature){
          map.removeLayer(identifiedFeature);
          pane.innerHTML = 'Loading';
        }
        states.identify().on(map).at(e.latlng).run(function(error, featureCollection){
          identifiedFeature = new L.GeoJSON(featureCollection.features[0], {
            style: function(){
              return {
                color: '#5C7DB8',
                weight: 2
              };
            }
          }).addTo(map);
          pane.innerHTML = featureCollection.features[0].properties.NAME;
        });
      });*/
    }  
  },500);
</script>

<div ng-include="'components/footer/footer.html'"></div>
