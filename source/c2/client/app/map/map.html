<style>
  #selectedFeatures {
    position: absolute;
    top: 100px;
    right: 280px;
    z-index: 10;
    background: white;
    padding: 1em;
  }
</style>

<div ng-include="'components/navbar/navbar.html'"></div>
<div class="container-fluid">
    <div class="row main-row">
        <!-- MAP VIEWER -->
        <div id="map" class="col-sm-10 map-col">
        </div>
        <div id="selectedFeatures" class="leaflet-bar">No State Selected</div>

        <!-- CRITERIA FILTERS -->
        <div class="col-sm-2 selector-col">
            <div ng-include="'components/criteria-picker/criteria-picker.html'"></div>
        </div>

    </div>
</div>
<script>
  function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
  }
  function onEachFeature(feature, layer) {
    layer.on({
      click: zoomToFeature
    });
  }
  var popup = L.popup();
  function onMapClick(e) {
      popup
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(map);
  }

  var identifiedFeature;
  var pane;
  var states;
  var map;

  // Workaround...
  var setint = setInterval(function() {

    if(typeof require != undefined) // && typeof L.esri != undefined && typeof L.esri.Geocoding != undefined) 
    {
      clearInterval(setint);

      map = L.map('map').setView([37.78, -92.85], 4); // All of US
      //map.on('click', onMapClick);

      L.esri.basemapLayer('Streets').addTo(map);
      console.log('Successfully loaded map!');
      //states = L.esri.featureLayer('http://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0', {
      //states = L.esri.dynamicMapLayer('http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer', {   
      states = L.esri.dynamicMapLayer('http://sampleserver5.arcgisonline.com/arcgis/rest/services/USA/MapServer', {
        layers: [2],
        opacity: 0.5,
        useCors: false
      }).addTo(map);
   
      // Auto-zoom on load
      /*L.esri.Geocoding.geocode().text('Virginia').run(function (error, response) {
          map.fitBounds(response.results[0].bounds);
      });*/
      
      var searchControl = new L.esri.Geocoding.Controls.Geosearch().addTo(map);
      var results = new L.LayerGroup().addTo(map);
      searchControl.on('results', function(data){
        results.clearLayers();
        for (var i = data.results.length - 1; i >= 0; i--) {
          results.addLayer(L.marker(data.results[i].latlng));
        }
      });

      pane = document.getElementById('selectedFeatures');
      map.on('click', function (e) {
        if(identifiedFeature){
          map.removeLayer(identifiedFeature);
          pane.innerHTML = 'Loading...';
        }
        states.identify().on(map).at(e.latlng).run(function(error, featureCollection){
          /*identifiedFeature = new L.GeoJSON(featureCollection.features[0], {
            style: function(){
              return {
                color: '#5C7DB8',
                weight: 2
              };
            }
          }).addTo(map);*/
          pane.innerHTML = 'Selected State: <b>' + featureCollection.features[0].properties.STATE_NAME + '</b>';
          //map.fitBounds(featureCollection.getBounds());

          /*// empty geojson feature collection
          var geojsonFeatureCollection = {
            type: 'FeatureCollection',
            features: []
          };

          for (var i = featureCollection.length - 1; i >= 0; i--) {
            // convert ArcGIS Feature to GeoJSON Feature
            var feature = L.esri.Util.arcgisToGeojson(identifiedFeature, idField);

            // unproject the web mercator coordinates to lat/lng
            var geoCoords = L.Projection.Mercator.unproject(L.polygon(feature.geometry));
            feature.geometry = geoCoords;

            geojsonFeatureCollection.features.push(feature);
          }

          var geojson = L.geoJson(geojsonFeatureCollection).addTo(map);
          map.fitBounds(geojson.getBounds());*/          
        });
      });
    }  
  },500);
</script>

<div ng-include="'components/footer/footer.html'"></div>
